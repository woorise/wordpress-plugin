{"version":3,"sources":["@wordpress/api-fetch/src/index.js"],"names":["DEFAULT_HEADERS","Accept","DEFAULT_OPTIONS","credentials","middlewares","userLocaleMiddleware","namespaceEndpointMiddleware","httpV1Middleware","fetchAllMiddleware","registerMiddleware","middleware","unshift","checkStatus","response","status","defaultFetchHandler","nextOptions","url","path","data","parse","remainingOptions","body","headers","JSON","stringify","responsePromise","window","fetch","location","href","then","value","Promise","resolve","catch","code","message","fetchHandler","setFetchHandler","newFetchHandler","apiFetch","options","enhancedHandler","reduceRight","next","workingOptions","error","reject","nonceEndpoint","text","nonceMiddleware","nonce","use","createNonceMiddleware","createPreloadingMiddleware","createRootURLMiddleware","mediaUploadMiddleware"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { __ } from '@wordpress/i18n';\n\n/**\n * Internal dependencies\n */\nimport createNonceMiddleware from './middlewares/nonce';\nimport createRootURLMiddleware from './middlewares/root-url';\nimport createPreloadingMiddleware from './middlewares/preloading';\nimport fetchAllMiddleware from './middlewares/fetch-all-middleware';\nimport namespaceEndpointMiddleware from './middlewares/namespace-endpoint';\nimport httpV1Middleware from './middlewares/http-v1';\nimport userLocaleMiddleware from './middlewares/user-locale';\nimport mediaUploadMiddleware from './middlewares/media-upload';\nimport {\n\tparseResponseAndNormalizeError,\n\tparseAndThrowError,\n} from './utils/response';\n\n/**\n * Default set of header values which should be sent with every request unless\n * explicitly provided through apiFetch options.\n *\n * @type {Record<string, string>}\n */\nconst DEFAULT_HEADERS = {\n\t// The backend uses the Accept header as a condition for considering an\n\t// incoming request as a REST request.\n\t//\n\t// See: https://core.trac.wordpress.org/ticket/44534\n\tAccept: 'application/json, */*;q=0.1',\n};\n\n/**\n * Default set of fetch option values which should be sent with every request\n * unless explicitly provided through apiFetch options.\n *\n * @type {Object}\n */\nconst DEFAULT_OPTIONS = {\n\tcredentials: 'include',\n};\n\n/**\n * @type {import('./types').ApiFetchMiddleware[]}\n */\nconst middlewares = [\n\tuserLocaleMiddleware,\n\tnamespaceEndpointMiddleware,\n\thttpV1Middleware,\n\tfetchAllMiddleware,\n];\n\n/**\n * Register a middleware\n *\n * @param {import('./types').ApiFetchMiddleware} middleware\n */\nfunction registerMiddleware( middleware ) {\n\tmiddlewares.unshift( middleware );\n}\n\n/**\n * Checks the status of a response, throwing the Response as an error if\n * it is outside the 200 range.\n *\n * @param {Response} response\n * @return {Response} The response if the status is in the 200 range.\n */\nconst checkStatus = ( response ) => {\n\tif ( response.status >= 200 && response.status < 300 ) {\n\t\treturn response;\n\t}\n\n\tthrow response;\n};\n\n/** @typedef {(options: import('./types').ApiFetchRequestProps) => Promise<any>} FetchHandler*/\n\n/**\n * @type {FetchHandler}\n */\nconst defaultFetchHandler = ( nextOptions ) => {\n\tconst { url, path, data, parse = true, ...remainingOptions } = nextOptions;\n\tlet { body, headers } = nextOptions;\n\n\t// Merge explicitly-provided headers with default values.\n\theaders = { ...DEFAULT_HEADERS, ...headers };\n\n\t// The `data` property is a shorthand for sending a JSON body.\n\tif ( data ) {\n\t\tbody = JSON.stringify( data );\n\t\theaders[ 'Content-Type' ] = 'application/json';\n\t}\n\n\tconst responsePromise = window.fetch(\n\t\t// fall back to explicitly passing `window.location` which is the behavior if `undefined` is passed\n\t\turl || path || window.location.href,\n\t\t{\n\t\t\t...DEFAULT_OPTIONS,\n\t\t\t...remainingOptions,\n\t\t\tbody,\n\t\t\theaders,\n\t\t}\n\t);\n\n\treturn (\n\t\tresponsePromise\n\t\t\t// Return early if fetch errors. If fetch error, there is most likely no\n\t\t\t// network connection. Unfortunately fetch just throws a TypeError and\n\t\t\t// the message might depend on the browser.\n\t\t\t.then(\n\t\t\t\t( value ) =>\n\t\t\t\t\tPromise.resolve( value )\n\t\t\t\t\t\t.then( checkStatus )\n\t\t\t\t\t\t.catch( ( response ) =>\n\t\t\t\t\t\t\tparseAndThrowError( response, parse )\n\t\t\t\t\t\t)\n\t\t\t\t\t\t.then( ( response ) =>\n\t\t\t\t\t\t\tparseResponseAndNormalizeError( response, parse )\n\t\t\t\t\t\t),\n\t\t\t\t() => {\n\t\t\t\t\tthrow {\n\t\t\t\t\t\tcode: 'fetch_error',\n\t\t\t\t\t\tmessage: __( 'You are probably offline.' ),\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t)\n\t);\n};\n\n/** @type {FetchHandler} */\nlet fetchHandler = defaultFetchHandler;\n\n/**\n * Defines a custom fetch handler for making the requests that will override\n * the default one using window.fetch\n *\n * @param {FetchHandler} newFetchHandler The new fetch handler\n */\nfunction setFetchHandler( newFetchHandler ) {\n\tfetchHandler = newFetchHandler;\n}\n\n/**\n * @template T\n * @param {import('./types').ApiFetchRequestProps} options\n * @return {Promise<T>} A promise representing the request processed via the registered middlewares.\n */\nfunction apiFetch( options ) {\n\t// creates a nested function chain that calls all middlewares and finally the `fetchHandler`,\n\t// converting `middlewares = [ m1, m2, m3 ]` into:\n\t// ```\n\t// opts1 => m1( opts1, opts2 => m2( opts2, opts3 => m3( opts3, fetchHandler ) ) );\n\t// ```\n\tconst enhancedHandler = middlewares.reduceRight( (\n\t\t/** @type {FetchHandler} */ next,\n\t\tmiddleware\n\t) => {\n\t\treturn ( workingOptions ) => middleware( workingOptions, next );\n\t}, fetchHandler );\n\n\treturn enhancedHandler( options ).catch( ( error ) => {\n\t\tif ( error.code !== 'rest_cookie_invalid_nonce' ) {\n\t\t\treturn Promise.reject( error );\n\t\t}\n\n\t\t// If the nonce is invalid, refresh it and try again.\n\t\treturn (\n\t\t\twindow\n\t\t\t\t// @ts-ignore\n\t\t\t\t.fetch( apiFetch.nonceEndpoint )\n\t\t\t\t.then( checkStatus )\n\t\t\t\t.then( ( data ) => data.text() )\n\t\t\t\t.then( ( text ) => {\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tapiFetch.nonceMiddleware.nonce = text;\n\t\t\t\t\treturn apiFetch( options );\n\t\t\t\t} )\n\t\t);\n\t} );\n}\n\napiFetch.use = registerMiddleware;\napiFetch.setFetchHandler = setFetchHandler;\n\napiFetch.createNonceMiddleware = createNonceMiddleware;\napiFetch.createPreloadingMiddleware = createPreloadingMiddleware;\napiFetch.createRootURLMiddleware = createRootURLMiddleware;\napiFetch.fetchAllMiddleware = fetchAllMiddleware;\napiFetch.mediaUploadMiddleware = mediaUploadMiddleware;\n\nexport default apiFetch;\n"]}