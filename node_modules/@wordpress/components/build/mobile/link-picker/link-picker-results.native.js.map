{"version":3,"sources":["@wordpress/components/src/mobile/link-picker/link-picker-results.native.js"],"names":["PER_PAGE","REQUEST_DEBOUNCE_DELAY","MINIMUM_QUERY_SIZE","meetsThreshold","query","length","LinkPickerResults","onLinkPicked","directEntry","links","setLinks","hasAllSuggestions","setHasAllSuggestions","nextPage","pendingRequest","clearRequest","current","select","getSettings","fetchLinkSuggestions","search","__experimentalFetchLinkSuggestions","page","type","perPage","fetchMore","currentSuggestions","request","suggestions","fetchMoreSuggestions","onEndReached","spinner","styles","listProps","item","url","contentContainerStyle","list"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { ActivityIndicator, FlatList, View } from 'react-native';\nimport { debounce } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { BottomSheet, BottomSheetConsumer } from '@wordpress/components';\nimport { useState, useEffect, useRef } from '@wordpress/element';\nimport { useSelect } from '@wordpress/data';\n\n/**\n * Internal dependencies\n */\nimport styles from './styles.scss';\n\nconst PER_PAGE = 20;\nconst REQUEST_DEBOUNCE_DELAY = 400;\nconst MINIMUM_QUERY_SIZE = 2;\nconst meetsThreshold = ( query ) => MINIMUM_QUERY_SIZE <= query.length;\n\nexport default function LinkPickerResults( {\n\tquery,\n\tonLinkPicked,\n\tdirectEntry,\n} ) {\n\tconst [ links, setLinks ] = useState( [ directEntry ] );\n\tconst [ hasAllSuggestions, setHasAllSuggestions ] = useState( false );\n\tconst nextPage = useRef( 1 );\n\tconst pendingRequest = useRef();\n\tconst clearRequest = () => {\n\t\tpendingRequest.current = null;\n\t};\n\n\t// a stable debounced function to fetch suggestions and append\n\tconst { fetchMoreSuggestions } = useSelect( ( select ) => {\n\t\tconst { getSettings } = select( 'core/block-editor' );\n\t\tconst fetchLinkSuggestions = async ( { search } ) => {\n\t\t\tif ( meetsThreshold( search ) ) {\n\t\t\t\treturn await getSettings().__experimentalFetchLinkSuggestions(\n\t\t\t\t\tsearch,\n\t\t\t\t\t{ page: nextPage.current, type: 'post', perPage: PER_PAGE }\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t\tconst fetchMore = async ( {\n\t\t\tquery: search,\n\t\t\tlinks: currentSuggestions,\n\t\t} ) => {\n\t\t\t// return early if we've already detected the end of data or we are\n\t\t\t// already awaiting a response\n\t\t\tif ( hasAllSuggestions || pendingRequest.current ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst request = fetchLinkSuggestions( { search } );\n\t\t\tpendingRequest.current = request;\n\t\t\tconst suggestions = await request;\n\n\t\t\t// only update links for the most recent request\n\t\t\tif ( suggestions && request === pendingRequest.current ) {\n\t\t\t\t// since we don't have the response header, we check if the results\n\t\t\t\t// are truncated to determine we've reached the end\n\t\t\t\tif ( suggestions.length < PER_PAGE ) {\n\t\t\t\t\tsetHasAllSuggestions( true );\n\t\t\t\t}\n\t\t\t\tsetLinks( [ ...currentSuggestions, ...suggestions ] );\n\t\t\t\tnextPage.current++;\n\t\t\t}\n\n\t\t\tclearRequest();\n\t\t};\n\t\treturn {\n\t\t\tfetchMoreSuggestions: debounce( fetchMore, REQUEST_DEBOUNCE_DELAY ),\n\t\t};\n\t}, [] );\n\n\t// prevent setting state when unmounted\n\tuseEffect( () => clearRequest, [] );\n\n\t// any time the query changes, we reset pagination\n\tuseEffect( () => {\n\t\tclearRequest();\n\t\tnextPage.current = 1;\n\t\tsetHasAllSuggestions( false );\n\t\tsetLinks( [ directEntry ] );\n\t\tfetchMoreSuggestions( { query, links: [ directEntry ] } );\n\t}, [ query ] );\n\n\tconst onEndReached = () => fetchMoreSuggestions( { query, links } );\n\n\tconst spinner = ! hasAllSuggestions && meetsThreshold( query ) && (\n\t\t<View style={ styles.spinner }>\n\t\t\t<ActivityIndicator animating />\n\t\t</View>\n\t);\n\n\treturn (\n\t\t<BottomSheetConsumer>\n\t\t\t{ ( { listProps } ) => (\n\t\t\t\t<FlatList\n\t\t\t\t\tdata={ links }\n\t\t\t\t\tkeyboardShouldPersistTaps=\"always\"\n\t\t\t\t\trenderItem={ ( { item } ) => (\n\t\t\t\t\t\t<BottomSheet.LinkSuggestionItemCell\n\t\t\t\t\t\t\tsuggestion={ item }\n\t\t\t\t\t\t\tonLinkPicked={ onLinkPicked }\n\t\t\t\t\t\t/>\n\t\t\t\t\t) }\n\t\t\t\t\tkeyExtractor={ ( { url, type } ) => `${ url }-${ type }` }\n\t\t\t\t\tonEndReached={ onEndReached }\n\t\t\t\t\tonEndReachedThreshold={ 0.1 }\n\t\t\t\t\tinitialNumToRender={ PER_PAGE }\n\t\t\t\t\tListFooterComponent={ spinner }\n\t\t\t\t\t{ ...listProps }\n\t\t\t\t\tcontentContainerStyle={ [\n\t\t\t\t\t\t...listProps.contentContainerStyle,\n\t\t\t\t\t\tstyles.list,\n\t\t\t\t\t] }\n\t\t\t\t/>\n\t\t\t) }\n\t\t</BottomSheetConsumer>\n\t);\n}\n"]}