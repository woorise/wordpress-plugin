"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = require("lodash");

var _data = require("@wordpress/data");

var _blocks = require("@wordpress/blocks");

var _i18n = require("@wordpress/i18n");

var _a11y = require("@wordpress/a11y");

var _element = require("@wordpress/element");

var _store = require("../../../store");

/**
 * External dependencies
 */

/**
 * WordPress dependencies
 */

/**
 * Internal dependencies
 */

/**
 * @typedef WPInserterConfig
 *
 * @property {string=}   rootClientId        If set, insertion will be into the
 *                                           block with this ID.
 * @property {number=}   insertionIndex      If set, insertion will be into this
 *                                           explicit position.
 * @property {string=}   clientId            If set, insertion will be after the
 *                                           block with this ID.
 * @property {boolean=}  isAppender          Whether the inserter is an appender
 *                                           or not.
 * @property {Function=} onSelect            Called after insertion.
 */

/**
 * Returns the insertion point state given the inserter config.
 *
 * @param {WPInserterConfig} config Inserter Config.
 * @return {Array} Insertion Point State (rootClientID, onInsertBlocks and onToggle).
 */
function useInsertionPoint(_ref) {
  var rootClientId = _ref.rootClientId,
      insertionIndex = _ref.insertionIndex,
      clientId = _ref.clientId,
      isAppender = _ref.isAppender,
      onSelect = _ref.onSelect,
      _ref$shouldFocusBlock = _ref.shouldFocusBlock,
      shouldFocusBlock = _ref$shouldFocusBlock === void 0 ? true : _ref$shouldFocusBlock;

  var _useSelect = (0, _data.useSelect)(function (select) {
    var _select = select(_store.store),
        _getSelectedBlock = _select.getSelectedBlock,
        getBlockIndex = _select.getBlockIndex,
        getBlockOrder = _select.getBlockOrder,
        getBlockInsertionPoint = _select.getBlockInsertionPoint;

    var _destinationRootClientId, _destinationIndex;

    if (rootClientId || insertionIndex || clientId || isAppender) {
      // If any of these arguments are set, we're in "manual mode"
      // meaning the insertion point is set by the caller.
      _destinationRootClientId = rootClientId;

      if (insertionIndex) {
        // Insert into a specific index.
        _destinationIndex = insertionIndex;
      } else if (clientId) {
        // Insert after a specific client ID.
        _destinationIndex = getBlockIndex(clientId, _destinationRootClientId);
      } else {
        // Insert at the end of the list.
        _destinationIndex = getBlockOrder(_destinationRootClientId).length;
      }
    } else {
      // Otherwise, we're in "auto mode" where the insertion point is
      // decided by getBlockInsertionPoint().
      var insertionPoint = getBlockInsertionPoint();
      _destinationRootClientId = insertionPoint.rootClientId;
      _destinationIndex = insertionPoint.index;
    }

    return {
      getSelectedBlock: _getSelectedBlock,
      destinationRootClientId: _destinationRootClientId,
      destinationIndex: _destinationIndex
    };
  }, [rootClientId, insertionIndex, clientId, isAppender]),
      destinationRootClientId = _useSelect.destinationRootClientId,
      destinationIndex = _useSelect.destinationIndex,
      getSelectedBlock = _useSelect.getSelectedBlock;

  var _useDispatch = (0, _data.useDispatch)(_store.store),
      replaceBlocks = _useDispatch.replaceBlocks,
      insertBlocks = _useDispatch.insertBlocks,
      showInsertionPoint = _useDispatch.showInsertionPoint,
      hideInsertionPoint = _useDispatch.hideInsertionPoint;

  var onInsertBlocks = (0, _element.useCallback)(function (blocks, meta) {
    var shouldForceFocusBlock = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
    var selectedBlock = getSelectedBlock();

    if (!isAppender && selectedBlock && (0, _blocks.isUnmodifiedDefaultBlock)(selectedBlock)) {
      replaceBlocks(selectedBlock.clientId, blocks, null, shouldFocusBlock || shouldForceFocusBlock ? 0 : null, meta);
    } else {
      insertBlocks(blocks, destinationIndex, destinationRootClientId, true, shouldFocusBlock || shouldForceFocusBlock ? 0 : null, meta);
    }

    var message = (0, _i18n.sprintf)( // translators: %d: the name of the block that has been added
    (0, _i18n._n)('%d block added.', '%d blocks added.', (0, _lodash.castArray)(blocks).length), (0, _lodash.castArray)(blocks).length);
    (0, _a11y.speak)(message);

    if (onSelect) {
      onSelect();
    }
  }, [isAppender, getSelectedBlock, replaceBlocks, insertBlocks, destinationRootClientId, destinationIndex, onSelect, shouldFocusBlock]);
  var onToggleInsertionPoint = (0, _element.useCallback)(function (show) {
    if (show) {
      showInsertionPoint(destinationRootClientId, destinationIndex);
    } else {
      hideInsertionPoint();
    }
  }, [showInsertionPoint, hideInsertionPoint, destinationRootClientId, destinationIndex]);
  return [destinationRootClientId, onInsertBlocks, onToggleInsertionPoint];
}

var _default = useInsertionPoint;
exports.default = _default;
//# sourceMappingURL=use-insertion-point.js.map